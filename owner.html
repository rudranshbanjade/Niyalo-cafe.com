<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Niyalo ¬∑ Owner Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#12100e;font-family:'Plus Jakarta Sans',sans-serif;padding:1.5rem;display:flex;justify-content:center;}
    .owner-container{max-width:1400px;width:100%;}
    .owner-header{background:rgba(28,24,22,0.95);border-radius:60px 60px 30px 30px;padding:1rem 1.8rem;margin-bottom:1.8rem;display:flex;justify-content:space-between;align-items:center;border-bottom:5px solid #c49a6c;}
    .logo-text h1{font-family:'Playfair Display',serif;color:#fcede5;font-size:1.6rem;}
    .edit-controls{display:flex;gap:0.8rem;align-items:center;flex-wrap:wrap;}
    .edit-mode-btn{background:#2d5a4b;color:white;padding:0.6rem 1.5rem;border-radius:60px;cursor:pointer;border:none;font-weight:600;}
    .edit-mode-btn.active{background:#c49a6c;}
    .save-btn{background:#27ae60;color:white;padding:0.6rem 1.8rem;border-radius:60px;cursor:pointer;border:none;font-weight:600;}
    .guest-link{background:#5f4a3d;color:white;padding:0.6rem 1.5rem;border-radius:60px;text-decoration:none;}
    
    .controls-toggle-btn {
      background: #8e6b4f;
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 60px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      width: fit-content;
    }
    
    .store-controls-panel {
      background: #fcf7f2;
      border-radius: 48px;
      padding: 1.8rem;
      margin-bottom: 2rem;
      display: none;
    }
    
    .store-controls-panel.show {
      display: block;
    }
    
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px dashed #d4b19b;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #27ae60;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .qr-upload {
      background: white;
      border-radius: 20px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .qr-preview {
      max-width: 150px;
      border-radius: 10px;
      margin: 1rem 0;
    }
    
    .upload-btn {
      background: #8e6b4f;
      color: white;
      border: none;
      border-radius: 60px;
      padding: 0.8rem 2rem;
      cursor: pointer;
      font-weight: 600;
    }
    
    .hotel-info {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 3px dashed #d4b19b;
      padding-bottom: 1.5rem;
    }
    
    .hotel-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .hotel-title i {
      color: #a57159;
      font-size: 2rem;
    }
    
    .hotel-details {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      color: #5f4a3d;
    }
    
    .hotel-contact {
      background: #fff1e9;
      padding: 0.7rem 1.5rem;
      border-radius: 60px;
      display: flex;
      gap: 1.2rem;
    }
    
    [contenteditable="true"]{outline:none;border-bottom:2px dashed #b18067;background:rgba(255,235,220,0.3);cursor:text;padding:0 4px;}
    .menu-master{background:#fcf7f2;border-radius:48px;padding:1.8rem;}
    .category-card{background:white;border-radius:36px;padding:1.5rem;margin-bottom:1.8rem;border:1px solid #efdbd1;}
    .category-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px dotted #eacbbe;padding-bottom:1rem;margin-bottom:1rem;}
    .category-title{display:flex;align-items:center;gap:10px;}
    .category-title i{font-size:1.8rem;color:#aa7862;}
    .category-title h3{font-family:'Playfair Display',serif;font-size:1.6rem;color:#3d2c24;}
    .menu-row{display:flex;justify-content:space-between;align-items:center;padding:0.7rem 0;border-bottom:1px dashed #efd9d0;}
    .item-name{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .item-desc{font-size:0.8rem;color:#6b5246;}
    .price-tag{font-weight:800;font-size:1.2rem;background:#ffefe7;padding:0.2rem 1.2rem;border-radius:60px;}
    .price-tag span:before{content:"‡§∞‡•Ç";margin-right:4px;}
    .delete-btn{background:#c0392b;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;}
    .add-item-btn{background:#2c5f4b;color:white;border:none;border-radius:60px;padding:0.5rem 1.5rem;margin-top:0.8rem;cursor:pointer;}
    .add-category-btn{background:#8e6b4f;color:white;border:none;border-radius:60px;padding:0.8rem 2rem;font-size:1rem;cursor:pointer;margin:1rem 0;}
    .add-footer-btn{background:#8f6e5a;color:white;border:none;border-radius:60px;padding:0.5rem 1.5rem;cursor:pointer;}
    .footer-editor{background:#fdf1ea;border-radius:60px;padding:1.5rem;margin-top:1.8rem;}
    .footer-badge-container{display:flex;flex-wrap:wrap;justify-content:center;gap:1rem;margin-bottom:1rem;}
    .footer-badge{background:#e7d2c5;border-radius:60px;padding:0.3rem 1.2rem;display:inline-flex;align-items:center;gap:8px;}
    .sync-status{display:flex;justify-content:flex-end;margin-top:1rem;}
    .sync-pulse{background:#2d5a4b;color:white;padding:0.6rem 1.8rem;border-radius:60px;}
    
    .hotel-info span[contenteditable="true"] {
      border-bottom: 2px dashed #b18067;
      background: rgba(255,235,220,0.3);
    }
  </style>
</head>
<body>
  <div class="owner-container">
    <div class="owner-header">
      <div class="logo-text">
        <h1><i class="fas fa-crown" style="color:#c49a6c;"></i> Niyalo ¬∑ Owner</h1>
      </div>
      <div class="edit-controls">
        <button id="editModeBtn" class="edit-mode-btn active">üîì EDIT ON</button>
        <button id="saveBtn" class="save-btn">üíæ SAVE TO CLOUD</button>
        <a href="index.html" target="_blank" class="guest-link">üëÅÔ∏è VIEW</a>
      </div>
    </div>

    <button class="controls-toggle-btn" id="toggleControlsBtn">
      <i class="fas fa-cog"></i> STORE CONTROLS <i class="fas fa-chevron-down" id="controlsChevron"></i>
    </button>

    <div class="store-controls-panel" id="storeControlsPanel">
      <h3 style="margin-bottom: 1.5rem;">‚öôÔ∏è Store Settings</h3>
      
      <div class="control-row">
        <div style="flex:1">
          <strong>Store Status</strong>
          <p style="color: #666; font-size: 0.9rem;">Open or close your store</p>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="storeOpenToggle" checked>
          <span class="toggle-slider"></span>
        </label>
        <span id="storeStatusText">Open</span>
      </div>

      <div class="control-row">
        <div style="flex:1">
          <strong>Pause Orders</strong>
          <p style="color: #666; font-size: 0.9rem;">Temporarily stop taking orders</p>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="pauseOrdersToggle">
          <span class="toggle-slider"></span>
        </label>
        <span id="pauseStatusText">Active</span>
      </div>

      <div class="control-row">
        <div style="flex:1">
          <strong>WhatsApp Number</strong>
          <p style="color: #666; font-size: 0.9rem;">Orders will be sent here</p>
        </div>
        <input type="text" id="ownerPhone" value="977981234567" style="padding:0.5rem; border-radius:60px; border:1px solid #ccc; width:200px;">
      </div>

      <div class="qr-upload">
        <strong>Payment QR Code</strong>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Upload a QR code for online payments</p>
        
        <div id="qrPreviewArea" style="display: none;">
          <img id="qrPreview" class="qr-preview" src="" alt="QR Code">
          <button id="removeQrBtn" class="delete-btn" style="width: auto; padding: 0.3rem 1rem; border-radius: 60px;">Remove QR</button>
        </div>
        
        <input type="file" id="qrUpload" accept="image/*" style="display: none;">
        <button id="uploadQrBtn" class="upload-btn">üì§ Upload QR Code</button>
        <button id="saveSettingsBtn" class="save-btn" style="margin-top: 1rem; width: 100%;">üíæ SAVE SETTINGS</button>
      </div>
    </div>

    <div class="menu-master" id="masterMenu">
      <!-- HOTEL INFO - EDIT MODE CONTROLLED -->
      <div class="hotel-info">
        <div>
          <div class="hotel-title">
            <i class="fas fa-leaf"></i>
            <span id="hotelName" class="editable-field">Niyalo Cafe</span>
            <i class="fas fa-mug-hot"></i>
          </div>
          <div class="hotel-details">
            <i class="fas fa-map-pin"></i>
            <span id="hotelLocation" class="editable-field">Kalkhanagar, Butwal</span>
            <span>‚Ä¢</span>
            <i class="fas fa-seedling"></i>
            <span id="hotelTagline" class="editable-field">handmade ¬∑ local love</span>
          </div>
        </div>
        <div class="hotel-contact">
          <span><i class="fas fa-clock"></i> <span id="hours" class="editable-field">7:00‚Äì22:00 daily</span></span>
          <span><i class="fas fa-phone-alt"></i> <span id="phone" class="editable-field">+977 976-6794282</span></span>
        </div>
      </div>

      <div id="categoriesContainer"></div>

      <div style="text-align:center;">
        <button class="add-category-btn" id="addCategoryBtn">‚ûï ADD NEW CATEGORY</button>
      </div>

      <div class="footer-editor">
        <div style="text-align:center;margin-bottom:1rem;">
          <span style="background:#ab8c7a;color:white;padding:0.3rem 1.5rem;border-radius:60px;">‚ù§Ô∏è FOOTER BADGES</span>
        </div>
        <div class="footer-badge-container" id="footerBadgesContainer"></div>
        <div style="text-align:center;margin-top:0.8rem;">
          <button class="add-footer-btn" id="addFooterBtn">‚ûï ADD BADGE</button>
        </div>
        <div style="text-align:center;margin-top:1.5rem;">
          <i class="fas fa-heart" style="color:#c2714b;"></i>
          <span id="heartNote" class="editable-field">order at counter ¬∑ everything made to share</span>
          <i class="fas fa-heart" style="color:#c2714b;"></i>
        </div>
      </div>
    </div>

    <div class="sync-status">
      <div class="sync-pulse" id="syncStatus">üü¢ READY</div>
    </div>
  </div>

  <script>
    const supabaseClient = window.supabase.createClient(
      'https://outxrzhbocyvopmivzzf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91dHhyemhib2N5dm9wbWl2enpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTU1NDgsImV4cCI6MjA4NjYzMTU0OH0.apOAqrdlz3WBo9Aht3xzHc-XBkInHSQVfHu3NRuCxNc'
    );

    const DEFAULT_MENU = {
      hotel: {
        name: "Niyalo Cafe",
        location: "Kalkhanagar, Butwal",
        tagline: "handmade ¬∑ local love",
        hours: "7:00‚Äì22:00 daily",
        phone: "+977 976-6794282",
        heartNote: "order at counter ¬∑ everything made to share"
      },
      footer: [
        { id: "footer1", text: "house-baked daily" },
        { id: "footer2", text: "vegan & gluten-free" },
        { id: "footer3", text: "free high-speed wifi" }
      ],
      categories: [
        { id: "cat1", title: "all-day breakfast", icon: "sunrise", items: [
          { id: "item1_1", name: "Egg - Roll.", desc: "poached eggs ¬∑ spiced tomato ¬∑ feta", price: "590", badge: null },
          { id: "item1_2", name: "Hehe", desc: "brioche ¬∑ orange ¬∑ maple", price: "520", badge: null },
          { id: "item1_3", name: "Avocado Garden Toast", desc: "sourdough ¬∑ za'atar ¬∑ radish", price: "580", badge: "vegan" },
          { id: "item1_4", name: "House Granola Pot", desc: "yoghurt ¬∑ berries ¬∑ honey", price: "420", badge: null }
        ]},
        { id: "cat2", title: "small plates", icon: "utensils", items: [
          { id: "item2_1", name: "Burnt Eggplant Dip", desc: "smoked paprika ¬∑ flatbread", price: "450", badge: null },
          { id: "item2_2", name: "Chili Garlic Prawns", desc: "lemon ¬∑ parsley ¬∑ sourdough", price: "690", badge: null },
          { id: "item2_3", name: "Wild Mushroom Toast", desc: "thyme ¬∑ truffle oil ¬∑ pecorino", price: "620", badge: "signature" },
          { id: "item2_4", name: "Harissa Cauliflower", desc: "tahini ¬∑ pomegranate ¬∑ almonds", price: "510", badge: null }
        ]}
      ]
    };

    let menuData = JSON.parse(JSON.stringify(DEFAULT_MENU));
    let storeSettings = {
      isOpen: true,
      ordersPaused: false,
      ownerPhone: "977981234567",
      paymentQrUrl: null
    };
    let isEditMode = true;

    // Function to update contenteditable on all editable fields
    function updateEditMode() {
      const editableFields = document.querySelectorAll('.editable-field');
      editableFields.forEach(field => {
        if (isEditMode) {
          field.setAttribute('contenteditable', 'true');
        } else {
          field.removeAttribute('contenteditable');
        }
      });
    }

    document.getElementById('toggleControlsBtn').addEventListener('click', function() {
      const panel = document.getElementById('storeControlsPanel');
      const chevron = document.getElementById('controlsChevron');
      panel.classList.toggle('show');
      chevron.className = panel.classList.contains('show') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    });

    async function loadAllData() {
      try {
        const { data } = await supabaseClient
          .from('menus')
          .select('*')
          .eq('id', 1)
          .single();
        if (data?.data) menuData = data.data;
      } catch(e) {}

      try {
        const { data } = await supabaseClient
          .from('settings')
          .select('*')
          .eq('id', 1)
          .single();
        if (data?.data) storeSettings = { ...storeSettings, ...data.data };
      } catch(e) {}

      renderAll();
      updateSettingsUI();
      updateEditMode();
    }

    function updateSettingsUI() {
      document.getElementById('storeOpenToggle').checked = storeSettings.isOpen;
      document.getElementById('pauseOrdersToggle').checked = storeSettings.ordersPaused;
      document.getElementById('ownerPhone').value = storeSettings.ownerPhone;
      
      document.getElementById('storeStatusText').textContent = storeSettings.isOpen ? 'Open' : 'Closed';
      document.getElementById('pauseStatusText').textContent = storeSettings.ordersPaused ? 'Paused' : 'Active';
      
      if (storeSettings.paymentQrUrl) {
        document.getElementById('qrPreview').src = storeSettings.paymentQrUrl;
        document.getElementById('qrPreviewArea').style.display = 'block';
      } else {
        document.getElementById('qrPreviewArea').style.display = 'none';
      }
    }

    function renderAll() {
      document.getElementById('hotelName').innerText = menuData.hotel.name;
      document.getElementById('hotelLocation').innerText = menuData.hotel.location;
      document.getElementById('hotelTagline').innerText = menuData.hotel.tagline;
      document.getElementById('hours').innerText = menuData.hotel.hours;
      document.getElementById('phone').innerText = menuData.hotel.phone;
      document.getElementById('heartNote').innerText = menuData.hotel.heartNote;

      renderCategories();
      renderFooter();
    }

    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';

      menuData.categories.forEach(cat => {
        const card = document.createElement('div');
        card.className = 'category-card';

        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `
          <div class="category-title">
            <i class="fas fa-${cat.icon}"></i>
            <h3><span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${cat.id}Title">${cat.title}</span></h3>
          </div>
          ${isEditMode ? `<button class="delete-cat-btn" onclick="deleteCategory('${cat.id}')">üóëÔ∏è DELETE</button>` : ''}
        `;
        card.appendChild(header);

        cat.items.forEach(item => {
          const row = document.createElement('div');
          row.className = 'menu-row';

          const leftDiv = document.createElement('div');
          leftDiv.style.flex = '1';

          const nameDiv = document.createElement('div');
          nameDiv.className = 'item-name';
          nameDiv.innerHTML = `<span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${item.id}">${item.name}</span>`;

          if (item.badge) {
            const badgeSpan = document.createElement('span');
            badgeSpan.style.cssText = 'background:#e7d2c5;border-radius:60px;padding:0.2rem 1rem;margin-left:8px;font-size:0.7rem;';
            badgeSpan.innerHTML = `
              <span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${item.id}Badge">${item.badge}</span>
              ${isEditMode ? `<button class="delete-btn" style="width:24px;height:24px;margin-left:6px;" onclick="deleteBadge('${item.id}')">√ó</button>` : ''}
            `;
            nameDiv.appendChild(badgeSpan);
          } else if (isEditMode) {
            const addBtn = document.createElement('button');
            addBtn.className = 'add-badge-btn';
            addBtn.style.cssText = 'background:#9f7e6b;color:white;border:none;border-radius:40px;padding:0.2rem 1rem;margin-left:8px;font-size:0.7rem;cursor:pointer;';
            addBtn.innerHTML = 'üè∑Ô∏è ADD BADGE';
            addBtn.onclick = (e) => { e.stopPropagation(); addBadgeToItem(item.id); };
            nameDiv.appendChild(addBtn);
          }

          const descDiv = document.createElement('div');
          descDiv.className = 'item-desc';
          descDiv.innerHTML = `<span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${item.id}Desc">${item.desc}</span>`;

          leftDiv.appendChild(nameDiv);
          leftDiv.appendChild(descDiv);

          const rightDiv = document.createElement('div');
          rightDiv.style.display = 'flex';
          rightDiv.style.alignItems = 'center';
          rightDiv.style.gap = '8px';

          const priceSpan = document.createElement('span');
          priceSpan.className = 'price-tag';
          priceSpan.innerHTML = `<span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${item.id}Price">${item.price}</span>`;

          if (isEditMode) {
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = 'üóëÔ∏è';
            delBtn.onclick = () => deleteMenuItem(cat.id, item.id);
            rightDiv.appendChild(delBtn);
          }

          rightDiv.appendChild(priceSpan);
          row.appendChild(leftDiv);
          row.appendChild(rightDiv);
          card.appendChild(row);
        });

        if (isEditMode) {
          const addBtn = document.createElement('button');
          addBtn.className = 'add-item-btn';
          addBtn.innerHTML = '‚ûï ADD NEW ITEM';
          addBtn.onclick = () => addNewItem(cat.id);
          card.appendChild(addBtn);
        }

        container.appendChild(card);
      });
    }

    function renderFooter() {
      const container = document.getElementById('footerBadgesContainer');
      container.innerHTML = '';
      
      menuData.footer.forEach(f => {
        const badge = document.createElement('span');
        badge.className = 'footer-badge';
        badge.innerHTML = `
          <i class="fas fa-heart" style="color:#a5664a;"></i>
          <span ${isEditMode ? 'contenteditable="true"' : ''} class="editable-field" id="${f.id}">${f.text}</span>
          ${isEditMode ? `<button class="delete-btn" style="width:24px;height:24px;" onclick="deleteFooterItem('${f.id}')">√ó</button>` : ''}
        `;
        container.appendChild(badge);
      });
    }

    window.deleteCategory = function(id) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      if (confirm('Delete category?')) {
        menuData.categories = menuData.categories.filter(c => c.id !== id);
        renderCategories();
      }
    };

    window.deleteMenuItem = function(catId, itemId) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      const cat = menuData.categories.find(c => c.id === catId);
      if (cat) {
        cat.items = cat.items.filter(i => i.id !== itemId);
        renderCategories();
      }
    };

    window.deleteBadge = function(itemId) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      menuData.categories.forEach(c => c.items.forEach(i => { if (i.id === itemId) i.badge = null; }));
      renderCategories();
    };

    window.deleteFooterItem = function(id) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      menuData.footer = menuData.footer.filter(f => f.id !== id);
      renderFooter();
    };

    window.addNewCategory = function() {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      const id = 'cat' + Date.now();
      menuData.categories.push({ id, title: 'New Category', icon: 'utensils', items: [] });
      renderCategories();
    };

    window.addNewItem = function(catId) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      const cat = menuData.categories.find(c => c.id === catId);
      if (cat) {
        cat.items.push({
          id: catId + '_item' + Date.now(),
          name: 'New Item',
          desc: 'item description',
          price: '199',
          badge: null
        });
        renderCategories();
      }
    };

    window.addBadgeToItem = function(itemId) {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      const text = prompt('Badge text:');
      if (text && text.trim()) {
        menuData.categories.forEach(c => c.items.forEach(i => { if (i.id === itemId) i.badge = text.trim(); }));
        renderCategories();
      }
    };

    window.saveMenuToSupabase = async function() {
      menuData.hotel.name = document.getElementById('hotelName').innerText;
      menuData.hotel.location = document.getElementById('hotelLocation').innerText;
      menuData.hotel.tagline = document.getElementById('hotelTagline').innerText;
      menuData.hotel.hours = document.getElementById('hours').innerText;
      menuData.hotel.phone = document.getElementById('phone').innerText;
      menuData.hotel.heartNote = document.getElementById('heartNote').innerText;

      menuData.footer.forEach(f => {
        const el = document.getElementById(f.id);
        if (el) f.text = el.innerText;
      });

      menuData.categories.forEach(cat => {
        const titleEl = document.getElementById(cat.id + 'Title');
        if (titleEl) cat.title = titleEl.innerText;
        cat.items.forEach(item => {
          const nameEl = document.getElementById(item.id);
          if (nameEl) item.name = nameEl.innerText;
          const descEl = document.getElementById(item.id + 'Desc');
          if (descEl) item.desc = descEl.innerText;
          const priceEl = document.getElementById(item.id + 'Price');
          if (priceEl) item.price = priceEl.innerText;
          const badgeEl = document.getElementById(item.id + 'Badge');
          if (badgeEl) item.badge = badgeEl.innerText;
        });
      });

      const { error } = await supabaseClient
        .from('menus')
        .upsert({ id: 1, data: menuData });

      if (error) {
        alert('Error saving menu: ' + error.message);
      } else {
        document.getElementById('syncStatus').innerHTML = '‚úÖ MENU SAVED ' + new Date().toLocaleTimeString();
      }
    };

    async function saveSettings() {
      storeSettings.isOpen = document.getElementById('storeOpenToggle').checked;
      storeSettings.ordersPaused = document.getElementById('pauseOrdersToggle').checked;
      storeSettings.ownerPhone = document.getElementById('ownerPhone').value;

      const { error } = await supabaseClient
        .from('settings')
        .upsert({ id: 1, data: storeSettings });

      if (error) {
        alert('Error saving settings: ' + error.message);
      } else {
        document.getElementById('syncStatus').innerHTML = '‚úÖ SETTINGS SAVED ' + new Date().toLocaleTimeString();
        updateSettingsUI();
      }
    }

    document.getElementById('uploadQrBtn').addEventListener('click', () => {
      document.getElementById('qrUpload').click();
    });

    document.getElementById('qrUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (event) => {
        storeSettings.paymentQrUrl = event.target.result;
        await saveSettings();
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('removeQrBtn').addEventListener('click', async () => {
      storeSettings.paymentQrUrl = null;
      await saveSettings();
    });

    document.getElementById('editModeBtn').addEventListener('click', function() {
      isEditMode = !isEditMode;
      this.innerHTML = isEditMode ? 'üîì EDIT ON' : 'üîí EDIT OFF';
      this.classList.toggle('active');
      renderCategories();
      renderFooter();
      updateEditMode();
    });

    document.getElementById('saveBtn').addEventListener('click', saveMenuToSupabase);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('addCategoryBtn').addEventListener('click', function() {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      addNewCategory();
    });
    document.getElementById('addFooterBtn').addEventListener('click', function() {
      if (!isEditMode) return alert('Turn ON Edit Mode first');
      menuData.footer.push({ id: 'footer' + Date.now(), text: 'new feature' });
      renderFooter();
    });

    loadAllData();
  </script>
</body>
</html>
